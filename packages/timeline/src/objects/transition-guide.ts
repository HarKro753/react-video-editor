import { Control, Rect, RectProps } from "fabric";
import { timeMsToUnits } from "../utils/timeline";
import {
  ACTIVE_SELECTION_COLOR,
  ACTIVE_SELECTION_WIDTH
} from "../constants/objects";
import { createTransitionControls } from "../utils";

interface TransitionGuideProps
  extends Pick<RectProps, "width" | "height" | "top" | "left"> {
  id: string;
}

class TransitionGuide extends Rect {
  static type = "TransitionGuide";
  public duration: number;
  public fromId: string;
  public toId: string;
  public itemType: string = "none";
  public isSelected = false;
  static createControls(): { controls: Record<string, Control> } {
    return { controls: createTransitionControls() };
  }

  static getDefaults(): Record<string, any> {
    return {
      ...super.getDefaults(),
      ...TransitionGuide.ownDefaults
    };
  }

  static ownDefaults = {
    objectCaching: false,
    borderColor: "transparent",
    stroke: "transparent",
    strokeWidth: 1.5,
    fill: "rgba(0,0,0, 0.85)",
    borderOpacityWhenMoving: 1,
    hoverCursor: "default",
    lockMovementX: true,
    lockMovementY: true,
    duration: 1500,
    rx: 8,
    ry: 8
  };

  constructor(props: TransitionGuideProps) {
    super(props);
    Object.assign(this, TransitionGuide.ownDefaults);
    this.id = props.id;
  }

  public updateCoords() {
    const canvas = this.canvas;
    if (!canvas) return;
    const fromObject = canvas.getObjects().find((o) => o.id === this.fromId);
    if (!fromObject) return;
    const size = timeMsToUnits(this.duration, this.tScale);
    const position = fromObject.left + fromObject.width - size / 2;
    this.set({
      width: size,
      left: position
    });
  }

  // add custom text to the track item
  public _render(ctx: CanvasRenderingContext2D) {
    super._render(ctx);
    this.drawTextIdentity(ctx);
    this.updateSelected(ctx);
  }

  public drawTextIdentity(ctx: CanvasRenderingContext2D) {
    const path = new Path2D(
      "M3 5.30359C3 3.93159 4.659 3.24359 5.629 4.21359L11.997 10.5826L10.583 11.9966L5 6.41359V17.5856L10.586 11.9996L10.583 11.9966L11.997 10.5826L12 10.5856L18.371 4.21459C19.341 3.24459 21 3.93159 21 5.30359V18.6956C21 20.0676 19.341 20.7556 18.371 19.7856L12 13.5L13.414 11.9996L19 17.5866V6.41359L13.414 11.9996L13.421 12.0056L12.006 13.4206L12 13.4136L5.629 19.7846C4.659 20.7546 3 20.0676 3 18.6956V5.30359Z"
    );
    ctx.save();
    ctx.translate(-12, -12);
    ctx.fillStyle = "#ffffff";
    ctx.fill(path);
    ctx.restore();
  }
  public setSelected(selected: boolean) {
    this.isSelected = selected;
    this.set({ dirty: true });
  }

  public updateSelected(ctx: CanvasRenderingContext2D) {
    if (this.isSelected) {
      ctx.save();
      ctx.beginPath();
      ctx.roundRect(
        -this.width / 2,
        -this.height / 2,
        this.width,
        this.height,
        this.rx
      );
      ctx.lineWidth = ACTIVE_SELECTION_WIDTH;
      ctx.strokeStyle = ACTIVE_SELECTION_COLOR;
      ctx.stroke();
      ctx.restore();
    }
  }
}

export default TransitionGuide;
